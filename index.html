<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda Online</title>
    <style>
        /* ... (CSS styles remain the same) ... */
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body class="theme-cyberpunk">

    <div id="configErrorView" class="fullscreen-view" style="display:none;">
        <div class="centered-card">
             <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 1.5rem;">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <h2>Error de Configuración</h2>
            <p id="configErrorMessage">No se pudo cargar la configuración. Revisa el archivo <code>config.js</code>.</p>
            <p class="form-hint">Asegúrate de que el archivo exista y no contenga errores de sintaxis.</p>
        </div>
    </div>

    <header class="header">
        <!-- ... (header content remains the same) ... -->
    </header>

    <div id="loginView" class="fullscreen-view" style="display:none;">
        <!-- ... (login form remains the same) ... -->
    </div>

    <div id="tiendaView">
        <!-- ... (store content remains the same) ... -->
    </div>

    <div id="adminView" style="display:none;">
        <!-- ... (admin panel remains the same) ... -->
    </div>

    <div id="cartModal" class="modal">
        <!-- ... (cart modal remains the same) ... -->
    </div>

    <div id="productoModal" class="modal">
        <!-- ... (product modal remains the same) ... -->
    </div>
    
    <div id="categoriaModal" class="modal">
        <!-- ... (category modal remains the same) ... -->
    </div>

    <div id="orderDetailsModal" class="modal">
        <!-- ... (order details modal remains the same) ... -->
    </div>

    <div id="productDetailModal" class="modal">
        <!-- ... (product detail modal remains the same) ... -->
    </div>
    
    <div id="importPreviewModal" class="modal">
        <!-- ... (import preview modal remains the same) ... -->
    </div>

    <div id="clientHistoryModal" class="modal">
        <!-- ... (client history modal remains the same) ... -->
    </div>

    <footer class="footer">
        <!-- ... (footer content remains the same) ... -->
    </footer>

    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tinycolor2/dist/tinycolor.min.js"></script>
    <script>
        let CLOUDINARY_CLOUD_NAME, CLOUDINARY_UPLOAD_PRESET, n8nWebhookUrl, n8nStatusUpdateWebhookUrl;

        // ... (the rest of the script remains largely the same, but initialization changes) ...

        function inicializarSupabase() {
            if (typeof APP_CONFIG === 'undefined' || !APP_CONFIG.supabase || !APP_CONFIG.supabase.url || !APP_CONFIG.supabase.anonKey || APP_CONFIG.supabase.url === 'YOUR_SUPABASE_URL') {
                const errorView = document.getElementById('configErrorView');
                const errorMessage = document.getElementById('configErrorMessage');
                errorMessage.innerHTML = `
                    No se encontraron las credenciales de Supabase en <code>config.js</code>. 
                    <br><br> Por favor, abre el archivo <code>config.js</code> y completa los campos <code>url</code> y <code>anonKey</code> de Supabase.
                `;
                errorView.style.display = 'flex';
                document.getElementById('tiendaView').style.display = 'none';
                return false;
            }

            try {
                supabaseClient = supabase.createClient(APP_CONFIG.supabase.url, APP_CONFIG.supabase.anonKey);
                return true;
            } catch (error) {
                console.error("Error initializing Supabase:", error);
                const errorView = document.getElementById('configErrorView');
                const errorMessage = document.getElementById('configErrorMessage');
                errorMessage.textContent = 'Las credenciales de Supabase en config.js son inválidas.';
                errorView.style.display = 'flex';
                return false;
            }
        }

        function loadConfig() {
            try {
                if (typeof APP_CONFIG === 'undefined') {
                    throw new Error("El objeto APP_CONFIG no está definido. Revisa config.js.");
                }
                CLOUDINARY_CLOUD_NAME = APP_CONFIG.cloudinary.cloudName;
                CLOUDINARY_UPLOAD_PRESET = APP_CONFIG.cloudinary.uploadPreset;
                n8nWebhookUrl = APP_CONFIG.n8n.webhookUrl;
                n8nStatusUpdateWebhookUrl = APP_CONFIG.n8n.statusUpdateWebhookUrl;
                return true;
            } catch (error) {
                console.error("Error cargando la configuración:", error);
                const errorView = document.getElementById('configErrorView');
                const errorMessage = document.getElementById('configErrorMessage');
                errorMessage.textContent = error.message;
                errorView.style.display = 'flex';
                document.getElementById('tiendaView').style.display = 'none';
                return false;
            }
        }

        async function startApp() {
            if (!loadConfig()) return; 
            
            loadTheme(); // Load theme preference first
            const isInitialized = inicializarSupabase();

            if (isInitialized) {
                await verificarSesion();
                await cargarConfiguracionGeneral(); // This now mainly applies names, logos, etc.
                await cargarCategorias();
                await cargarProductos();
                
                // ... (event listeners remain the same) ...
            }
        }

        // The `guardarCredencialesSupabase` function is no longer needed and should be removed.
        // The `setupView` is also no longer needed and can be removed from the HTML.

        // Modify `aplicarConfiguracionUI` to use APP_CONFIG directly for static text
        function aplicarConfiguracionUI() {
            // ... (Apply theme and logo as before)

            document.title = APP_CONFIG.businessName || "Tienda Online";
            // ... (rest of the function uses APP_CONFIG for business name, slogan, etc.)
        }

        document.addEventListener('DOMContentLoaded', startApp);

        // ... (rest of the JavaScript code remains the same)

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>